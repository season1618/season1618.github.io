# ブログ緒言
ブログは高校の時からはてなブログを使っていたのだが、はてなの数式記法にはうんざりしていたしスタイルにも不満があった。かといってQiitaやZennなんかは技術記事を対象としているから、純粋に数学や物理、その他趣味や個人的なことを書くには適さない。ポートフォリオとブログが分離するのも微妙だ。適当な静的サイトジェネレータを使ってgithub.ioにでもブログを置くのが良い。

Markdownの方言には色々あるが、自分の望む機能を完璧に備えているものはなさそうだった。機能が足りないとなるとHTMLに頼って原始的な方法でスタイルを制御することになる。構文が厳密に与えられていなかったり冗長だったりするのも気に入らない。

そういうわけでマークアップ言語を自作するところから始めた。自作といってもMarkdownを基本的には受け継いでいるので方言の範疇かもしれないが、構文を厳密に規定し、冗長な部分を排し、自分が書きやすいように改めた。自分が使うためのものなので全然汎用的ではないと思う。

@[](https://github.com/season1618/notex)

処理系は文書全体を読み込み、タイトルや目次などのメタデータを取り出しつつ、ユーザが用意したテンプレートに埋め込む形でHTMLを生成する。

形式構文は以下の通り。

```
document = block*

block = header
      | quote
      | list
      | table
      | image
      | link-card
      | math-block
      | code-block
      | paragraph
      | ref
header = ("# " | "## " | "### " | "#### " | "##### " | "###### ") inline
quote = >> inline* <<
list = (("- " | "+ ") inline EOL)*
table = ("|" ( inline "|" )* EOL)* "-"+ EOL ("|" ( inline "|" )* EOL)*
image = @[ inline ]( url )
link-card = @[]( url )
math-block = $$ .. $$
code-block = \``` .. \```
paragraph = inline
ref = [^]

inline = cite*
cite = [^ link* ]
     | link
link = [ emph* ]( url )
     | emph
emph = ** emph* **
     | __ emph* __
     | prim
prim = math = $ .. $
     | code = ` .. `
     | text
```

Markdownでは順序無しリストの開始記号が複数あったが、NotexではTypstに倣い`- `を順序無しリスト、`+ `を順序付きリストとした。Markdownの強調は`*`または`_`で囲むと斜体、`**`または`__`で囲むとボールド体だったが、Notexでは`**`で囲むとボールド体、`__`で囲むと斜体とした。

ところで強調や数式・コードなどで開始記号と終了記号が同一だと構文がネストしないことが保証されるので都合が良い。構文の開始記号と終了記号を同一にする利点はネストしないのが示唆されること、欠点は終了記号を忘れたときにエラーとして報告される箇所が大きくずれることだ。インライン要素ならともかく数式・コードブロックの場合、文書最下段までエラーがずれる可能性があるが、実際そこまで困ることはないと思い特に対処はしていない。

リンクテキストが空の場合は、URLからHTMLを読んでtitle要素を差し込む。リンクカードも自動で生成するようにした。

各要素で注やリンクといった修飾が利用できるかどうかには注意を払った。見出しにも注やリンクは利用できるが、目次として取り出される際は、見出しテキストの内、注は除外されリンクはリンクテキストのみが抽出される。目次中の見出しには対応する本文中の見出しへのリンクが貼られるので、それ以外のリンクは無効になるためだ。

注は文書の最後にまとめて表示したいとは限らないため、任意の箇所でリストできるようにした。`[^]`と書くと、それ以前の注の内まだリストされていないものを全てリストする。また`[^]`でリストされない注は文書の最後で回収される。